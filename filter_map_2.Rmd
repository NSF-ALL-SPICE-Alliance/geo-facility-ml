---
title: "Filter Map"
author: "Connor Flynn"
date: "5/20/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(readxl)
library(here)
library(tidygeocoder)
library(mapview)
library(shiny)
library(leaflet)
library(dplyr)
```

Read in Data

```{r}
#facilities <- read_excel(here("National_Directory_MH_Facilities_2022.xlsx"))
```


Merge Columns

```{r}
# facilities <- facilities %>%
#   unite(whole_adress, c("street1", "city", "state", "zip"), sep = " ")
```

Geocode facilities (Takes 2.5 hours to run)

```{r}
# facilities <- facilities %>%
#   geocode(whole_adress, method = 'osm', lat = latitude , long = longitude)
```

Save geocoded facilities file

```{r}
#write_csv(facilities, here("geocoded_facilities.csv"))
```

Read in geocoded facilities file

```{r}
geocoded_facilities <- read_csv(here("geocoded_facilities.csv"))
```


```{r}
geocoded_facilities_filtered <- geocoded_facilities %>% 
  drop_na(longitude, latitude)
```


```{r}
mapview(geocoded_facilities_filtered, xcol = "longitude", ycol = "latitude", popup = "name1", crs = 4269, grid = FALSE, cex = 5)
```



```{r}
geocoded_facilities_filtered <- geocoded_facilities_filtered %>% 
  select(name1, service_code_info, latitude, longitude)
```


```{r}
# Define categories and corresponding abbreviations
abbrev_dict <- list(
  "Treatment Types" = c("MH", "SUMH", "OP", "PHDT", "RES", "CMHC"),
  "Medications" = c("CHLOR", "FLUPH", "HALOP", "LOXAP", "PERPH", "PIMOZ",
                    "PROCH", "THIOT", "THIOR", "TRIFL", "ARIPI", "ASENA",
                    "BREXP", "CARIP", "CLOZA", "ILOPE", "LURAS", "OLANZ",
                    "OLANZF", "PALIP", "QUETI", "RISPE", "ZIPRA", "NRT",
                    "NSC", "ANTPYCH"),
  "Therapies and Treatment Approaches" = c("AT", "CBT", "CRT", "CFT", "DBT",
                                           "ECT", "EMDR", "GT", "IDD", "IPT",
                                           "KIT", "TMS", "TELE"),
  "Assessments and Scales" = c("AIM"),
  "Emergency and Crisis Services" = c("CIT", "PEON", "PEOFF", "WI"),
  "Government and Organization Types" = c("LCCG", "DDF", "IH", "PVTP", "PVTN",
                                          "STG", "TBG", "VAMC", "FED", "FQHC",
                                          "MHC"),
  "Funding Sources" = c("CLF", "CMHG", "CSBG", "FG", "ITU", "MC", "MD",
                        "MI", "OSF", "PI", "SCJJ", "SEF", "SF", "SMHA",
                        "SWFS", "VAF", "PA", "SS"),
  "Target Populations" = c("TAY", "SE", "GL", "VET", "ADM", "MF", "CJ", "CO",
                            "HV", "DV", "TRMA", "TBI", "ALZ", "PED", "PEFP",
                            "PTSD", "SED", "SMI"),
  "Health Screenings and Tests" = c("STU", "HIVT", "STDT", "TBS", "MST", "HBT",
                                    "HCT", "LABT"),
  "Support and Rehabilitation Services" = c("HS", "PEER", "TCC", "ACT", "AOT",
                                            "CDM", "COOT", "DEC", "FPSY", "ICM",
                                            "IMR", "LAD", "PRS", "SEMP", "SH",
                                            "TPC", "VRS", "CM", "IPC", "SPS"),
  "Smoking and Vaping Policies" = c("SMON", "SMOP", "SMPD", "VAPN", "VAPP",
                                     "VPPD"),
  "Language Services" = c("SP", "AH", "NX", "FX")
)

```

```{r}
full_definitions<-c("SA" = "Substance use treatment",
  "MH" = "Mental health treatment",
  "SUMH" = "Treatment for co-occurring substance use plus either serious mental health illness in adults/serious emotional disturbance in children",
  "HI" = "Hospital inpatient/24-hour hospital inpatient",
  "OP" = "Outpatient",
  "PHDT" = "Partial hospitalization/day treatment",
  "RES" = "Residential/24-hour residential",
  "CMHC" = "Community mental health center",
  "CBHC" = "Certified Community Behavioral Health Clinic",
  "MSMH" = "Multi-setting mental health facility (e.g., non-hospital residential plus either outpatient and/or partial hospitalization/day treatment)",
  "OMH" = "Outpatient mental health facility",
  "ORES" = "Other residential treatment facility",
  "PH" = "Partial hospitalization/day treatment",
  "PSY" = "Psychiatric hospital",
  "RTCA" = "Residential treatment center (RTC) for adults",
  "RTCC" = "Residential treatment center (RTC) for children",
  "IPSY" = "Separate inpatient psychiatric unit of a general hospital",
  "SHP" = "State hospital",
  "VAHC" = "Veterans Affairs Medical Center or other VA healthcare facility",
  "CHLOR" = "Chlorpromazine",
  "DROPE" = "Droperidol",
  "FLUPH" = "Fluphenazine",
  "HALOP" = "Haloperidol",
  "LOXAP" = "Loxapine",
  "PERPH" = "Perphenazine",
  "PIMOZ" = "Pimozide",
  "PROCH" = "Prochlorperazine",
  "THIOT" = "Thiothixene",
  "THIOR" = "Thioridazine",
  "TRIFL" = "Trifluoperazine",
  "ARIPI" = "Aripiprazole",
  "ASENA" = "Asenapine",
  "BREXP" = "Brexpiprazole",
  "CARIP" = "Cariprazine",
  "CLOZA" = "Clozapine",
  "ILOPE" = "Iloperidone",
  "LURAS" = "Lurasidone",
  "OLANZ" = "Olanzapine",
  "OLANZF" = "Olanzapine/Fluoxetine combination",
  "PALIP" = "Paliperidone",
  "QUETI" = "Quetiapine",
  "RISPE" = "Risperidone",
  "ZIPRA" = "Ziprasidone",
  "NRT" = "Nicotine replacement",
  "NSC" = "Non-nicotine smoking/tobacco cessation",
  "ANTPYCH" = "Antipsychotics used in treatment of SMI",
  "AT" = "Activity therapy",
  "CBT" = "Cognitive behavioral therapy",
  "CRT" = "Cognitive remediation therapy",
  "CFT" = "Couples/family therapy",
  "DBT" = "Dialectical behavior therapy",
  "ECT" = "Electroconvulsive therapy",
  "EMDR" = "Eye Movement Desensitization and Reprocessing therapy",
  "GT" = "Group therapy",
  "IDD" = "Integrated Mental and Substance Use Disorder treatment",
  "IPT" = "Individual psychotherapy",
  "KIT" = "Ketamine Infusion Therapy",
  "TMS" = "Transcranial Magnetic Stimulation",
  "TELE" = "Telemedicine/telehealth therapy",
  "AIM" = "Abnormal involuntary movement scale",
  "CIT" = "Crisis intervention team",
  "PEON" = "Psychiatric emergency onsite services",
  "PEOFF" = "Psychiatric emergency mobile/off-site services",
  "WI" = "Psychiatric emergency walk-in services",
  "LCCG" = "Local, county, or community government",
  "DDF" = "Department of Defense",
  "IH" = "Indian Health Services",
  "PVTP" = "Private for-profit organization",
  "PVTN" = "Private non-profit organization",
  "STG" = "State government",
  "TBG" = "Tribal government",
  "VAMC" = "U.S. Department of Veterans Affairs",
  "FED" = "Federal Government",
  "FQHC" = "Federally Qualified Health Center",
  "MHC" = "Mental health clinic or mental health center",
  "CLF" = "County or local government funds",
  "CMHG" = "Community Mental Health Block Grants",
  "CSBG" = "Community Service Block Grants",
  "FG" = "Federal Grants",
  "ITU" = "IHS/Tribal/Urban (ITU) funds",
  "MC" = "Medicare",
  "MD" = "Medicaid",
  "MI" = "Federal military insurance (e.g., TRICARE)",
  "OSF" = "Other State funds",
  "PI" = "Private health insurance",
  "PCF" = "Private or Community foundation",
  "SCJJ" = "State corrections or juvenile justice funds",
  "SEF" = "State education agency funds",
  "SF" = "Cash or self-payment",
  "SI" = "State-financed health insurance plan other than Medicaid",
  "SMHA" = "State mental health agency (or equivalent) funds",
  "SWFS" = "State welfare or child and family services funds",
  "VAF" = "U.S. Department of VA funds",
  "PA" = "Payment assistance (check with facility for details)",
  "SS" = "Sliding fee scale (fee is based on income and other factors)",
  "TAY" = "Young adults",
  "SE" = "Seniors or older adults",
  "GL" = "Lesbian, gay, bisexual, transgender, or queer/questioning (LGBTQ)",
  "VET" = "Veterans",
  "ADM" = "Active duty military",
  "MF" = "Members of military families",
  "CJ" = "Criminal justice (other than DUI/DWI)/Forensic clients",
  "CO" = "Clients with co-occurring mental and substance use disorders",
  "HV" = "Clients with HIV or AIDS",
  "DV" = "Clients who have experienced intimate partner violence, domestic violence",
  "TRMA" = "Clients who have experienced trauma",
  "TBI" = "Persons with traumatic brain injury (TBI)",
  "ALZ" = "Persons with Alzheimer's or dementia",
  "PED" = "Persons with eating disorders",
  "PEFP" = "Persons experiencing first-episode psychosis",
  "PTSD" = "Persons with post-traumatic stress disorder (PTSD)",
  "SED" = "Children/adolescents with serious emotional disturbance (SED)",
  "SMI" = "Persons 18 and older with serious mental illness (SMI)",
  "STU" = "Screening for tobacco use",
  "HIVT" = "HIV testing",
  "STDT" = "STD testing",
  "TBS" = "TB screening",
  "MST" = "Metabolic syndrome monitoring",
  "HBT" = "Testing for Hepatitis B (HBV)",
  "HCT" = "Testing for Hepatitis C (HCV)",
  "LABT" = "Laboratory testing",
  "HS" = "Housing services",
  "PEER" = "Mentoring/peer support",
  "TCC" = "Education and Counseling Services",
  "SMON" = "Smoking not permitted",
  "SMOP" = "Smoking permitted without restriction",
  "SMPD" = "Smoking permitted in designated area",
  "CHLD" = "Children/adolescents",
  "SNR" = "Seniors",
  "YAD" = "Young adults",
  "SP" = "Spanish",
  "AH" = "Sign language services for the deaf and hard of hearing",
  "NX" = "American Indian or Alaska Native languages",
  "FX" = "Other languages (excluding Spanish)",
  "VAPN" = "Vaping not permitted",
  "VAPP" = "Vaping permitted without restriction",
  "VPPD" = "Vaping permitted in designated area",
  "ACT" = "Assertive community treatment",
  "AOT" = "Assisted Outpatient Treatment",
  "CDM" = "Chronic disease/illness management",
  "COOT" = "Court-ordered outpatient treatment",
  "DEC" = "Diet and exercise counseling",
  "FPSY" = "Family psychoeducation",
  "ICM" = "Intensive case management",
  "IMR" = "Illness management and recovery",
  "LAD" = "Legal advocacy",
  "PRS" = "Psychosocial rehabilitation services",
  "SEMP" = "Supported employment",
  "SH" = "Supported housing",
  "TPC" = "Therapeutic foster care",
  "VRS" = "Vocational rehabilitation services",
  "CM" = "Case management service",
  "IPC" = "Integrated primary care services",
  "SPS" = "Suicide prevention services",
"SMON" = "Smoking not permitted", "SMOP" = "Smoking permitted without restriction", "SMPD" = "Smoking permitted in designated area", "VAPN" = "Vaping not permitted", "VAPP" = "Vaping permitted without restriction", "VPPD" = "Vaping permitted in designated area",
"SP" = "Spanish",
"AH" = "Sign language services for the deaf and hard of
hearing",
"NX" = "American Indian or Alaska Native languages",
"FX" = "Other languages (excluding Spanish)")
```

```{r}
replace_abbrev_with_full <- function(abbrev_list, mapping) {
  full_list <- sapply(abbrev_list, function(abbrev) {
    if (abbrev %in% names(mapping)) {
      return(mapping[[abbrev]])
    } else {
      return(abbrev)
    }
  }, USE.NAMES = FALSE)
  return(full_list)
}

for (category in names(abbrev_dict)) {
  abbrev_dict[[category]] <- replace_abbrev_with_full(abbrev_dict[[category]], full_definitions)
}

```

```{r}
# UI
ui <- fluidPage(
  selectInput("overall_category", "Select Overall Category:", choices = names(abbrev_dict)),
  selectInput("service", "Select Service:", choices = NULL),
  leafletOutput("map")
)

# Server
server <- function(input, output, session) {

  # Observe changes in overall_category and update service choices dynamically
  observeEvent(input$overall_category, {
    req(input$overall_category)
    updateSelectInput(session, "service", choices = abbrev_dict[[input$overall_category]])
  })

  # Reactive expression to filter data based on selected category and service
  filtered_data <- reactive({
    req(input$overall_category, input$service)
    
    services <- strsplit(geocoded_facilities_filtered$service_code_info, " \\* ")
    
    filtered <- geocoded_facilities_filtered[sapply(services, function(x) {
      any(grepl(input$service, x))
    }), ]
    
    return(filtered)
  })

  # Render leaflet map
  output$map <- renderLeaflet({
    leaflet() %>%
      addTiles()
  })

  # Observe changes in filtered_data and update map markers
  observe({
    data <- filtered_data()
    req(nrow(data) > 0)
    
    leafletProxy("map", data = data) %>%
      clearMarkers() %>%
      addCircleMarkers(
        lng = ~longitude, lat = ~latitude,
        popup = ~name1,
        radius = 5,
        color = "blue",
        stroke = FALSE,
        fillOpacity = 0.7
      ) %>%
      setView(
        lng = mean(data$longitude, na.rm = TRUE), 
        lat = mean(data$latitude, na.rm = TRUE), 
        zoom = 6
      )
  })
}

shinyApp(ui = ui, server = server)

```


